<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AdminLTE 3 | Dashboard</title>

    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&amp;display=fallback" rel="stylesheet">
    <link href="plugins/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet">
    <link href="plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet">
    <link href="plugins/icheck-bootstrap/icheck-bootstrap.min.css" rel="stylesheet">
    <link href="plugins/jqvmap/jqvmap.min.css" rel="stylesheet">
    <link href="dist/css/adminlte.min.css?v=3.2.0" rel="stylesheet">
    <link href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css" rel="stylesheet">
    <link href="plugins/daterangepicker/daterangepicker.css" rel="stylesheet">
    <link href="plugins/summernote/summernote-bs4.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<section class="content">
    <div class="container-fluid">
        <!-- Form chọn tháng -->
        <form action="/manager/<%= hotel._id %>/statistical" method="GET" class="mb-4">
            <div class="form-group">
                <label for="periodType">Chọn loại thời gian:</label>
                <select id="periodType" name="type" class="form-control">
                    <option value="month" selected>Tháng</option>
                    <option value="quarter">Quý</option>
                    <option value="year">Năm</option>
                </select>
            </div>
        
            <div class="form-group" id="monthInput">
                <label for="month">Chọn tháng:</label>
                <input type="month" id="month" name="month" class="form-control" value="<%= new Date().toISOString().slice(0, 7) %>">
            </div>
        
            <div class="form-group d-none" id="quarterInput">
                <label for="quarter">Chọn quý:</label>
                <select id="quarter" name="quarter" class="form-control">
                    <option value="<%= new Date().getFullYear() %>-1">Quý 1</option>
                    <option value="<%= new Date().getFullYear() %>-2">Quý 2</option>
                    <option value="<%= new Date().getFullYear() %>-3">Quý 3</option>
                    <option value="<%= new Date().getFullYear() %>-4">Quý 4</option>
                </select>
            </div>
        
            <div class="form-group d-none" id="yearInput">
                <label for="year">Chọn năm:</label>
                <input type="number" id="year" name="year" class="form-control" value="<%= new Date().getFullYear() %>" min="2000" max="2100">
            </div>
        
            <button type="submit" class="btn btn-primary mt-2">Xem thống kê</button>
            <button type="button" id="resetButton" class="btn btn-secondary mt-2">Xóa phân loại</button>
        </form>

        <!-- Thống kê tổng quan -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3><%= number_room %></h3>
                        <p>Phòng</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-bag"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3><%= number_of_booking %></h3>
                        <p>Đặt phòng</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-stats-bars"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3><%= number_of_user %></h3>
                        <p>Khách hàng</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-person-add"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3><%= number_of_event %></h3>
                        <p>Sự kiện</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-pie-graph"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Biểu đồ và thông tin loại phòng -->
        <div class="row mt-4">
            <div class="card col-12">
                <div class="card-header ui-sortable-handle">
                    <h3 class="card-title">
                        <i class="fas fa-chart-pie mr-1"></i>
                        Loại phòng được đặt nhiều nhất trong <%= type === 'month' ? 'tháng' : type === 'year' ? 'năm' : 'quý' %> <%= type === 'month' ? month : type === 'quarter' ? quarter : year %>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="tab-content p-0">
                        <% for(let typeroom of best_type_room.typeOfRooms) { %>
                            <div>Loại phòng: <%= typeroom.name %></div>
                            <div>Số lượng đặt: <%= best_type_room.maxCount %></div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Biểu đồ -->
        <div class="row mt-4">
            <div class="col-12">
                <canvas id="roomBookingChart" width="200" height="100"></canvas>
            </div>
        </div>
    </div>
</section>

<style>
    #roomBookingChart {
        width: 300px; /* Chiều rộng mong muốn */
        height: 300px; /* Chiều cao mong muốn */
    }
</style>

<script>
    const bookedCountPerTypeRoom = <%- JSON.stringify(best_type_room.bookedCountPerTypeRoom) %>;

    const roomTypes = Object.keys(bookedCountPerTypeRoom);
    const bookingCounts = Object.values(bookedCountPerTypeRoom);

    const ctx = document.getElementById('roomBookingChart').getContext('2d');
    const roomBookingChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: roomTypes,
            datasets: [{
                label: 'Số lượng đặt phòng',
                data: bookingCounts,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true, // Đảm bảo biểu đồ có thể tự động điều chỉnh
            maintainAspectRatio: false, // Tắt tỷ lệ khung hình để có thể điều chỉnh kích thước
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Số lần đặt từng loại phòng'
                }
            }
        }
    });

    const periodTypeSelect = document.getElementById('periodType');
    const monthInput = document.getElementById('monthInput');
    const quarterInput = document.getElementById('quarterInput');
    const yearInput = document.getElementById('yearInput');

    periodTypeSelect.addEventListener('change', function() {
        switch (this.value) {
            case 'month':
                monthInput.classList.remove('d-none');
                quarterInput.classList.add('d-none');
                yearInput.classList.add('d-none');
                break;
            case 'quarter':
                monthInput.classList.add('d-none');
                quarterInput.classList.remove('d-none');
                yearInput.classList.add('d-none');
                break;
            case 'year':
                monthInput.classList.add('d-none');
                quarterInput.classList.add('d-none');
                yearInput.classList.remove('d-none');
                break;
        }
    });

    resetButton.addEventListener('click', function() {
        window.location.href = '/manager/<%= hotel._id %>/statistical';
    });
</script>
